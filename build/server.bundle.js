!function(e){var n={};function o(t){if(n[t])return n[t].exports;var s=n[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,n){if(1&n&&(e=o(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)o.d(t,s,function(n){return e[n]}.bind(null,s));return t},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="/",o(o.s=8)}([function(e,n){e.exports=require("express")},function(e,n){e.exports=require("dotenv")},function(e,n){e.exports=require("csv-parse")},function(e,n){e.exports=require("multer")},function(e,n,o){o(1).config(),storeData={token:null,user:null},e.exports={createLoginMap:function(e,n,o,t,s){return{IdentityPoolId:e,Logins:(r={},c=n,i=o,c in r?Object.defineProperty(r,c,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[c]=i,r),LoginId:t,region:s};var r,c,i},storeData:storeData,showstuff:function(){console.log(process.env.IdentityPoolId)}}},function(e,n){function o(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var o=[],t=!0,s=!1,r=void 0;try{for(var c,i=e[Symbol.iterator]();!(t=(c=i.next()).done)&&(o.push(c.value),!n||o.length!==n);t=!0);}catch(e){s=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(s)throw r}}return o}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var t={ACCOUNT:20,DESCRIPTION:21,AMOUNT:22,CODE:23,YEAR:24,MONTH:25,ID:26};e.exports={storeData:function(e){var n,s=[];n=e;var r=[],c=function(e){this.gridColumnEvents=e},i=0;if(Object.entries(n[0]).map(function(e){var n=o(e,2),s=n[0];return n[1],s.toUpperCase()in t}).includes(!1))return!1;for(;i<n.length;){var a=Object.entries(n[i]).map(function(e){var n=o(e,2),s=n[0];return{value:n[1],command:"SetGridCellValue",columnID:t[s.toUpperCase().trim()]}});r.push(a),i++}for(var u=0;u<r.length;){var l=new c(r[u]);s.push(l),u++}return{finalForJDE:s,originalData:n}}}},function(e,n,o){var t=o(2);o(14);e.exports={readFile:function(e,n,o,s){var r=[];t(e,{columns:!0}).on("data",function(e){Object.keys(e).map(function(n,o){r.push(e[n])})}).on("end",function(){!function(e,n,o,t){var s=o,r={val:"",status:null};if(e.includes(o.toUpperCase())){try{Object.values(n.originalData).forEach(function(e){if(e.Code.toUpperCase()!==s)throw r.val=e.Code.toUpperCase(),r.status=!1,"unauthorized";r.val=s,r.status=!0})}catch(e){if("unauthorized"===e)return t("Partner does not exist"),!1}t("Partner exists")}else t("Partner does not exist")}(r,n,o,s)})}}},function(e,n){e.exports=require("aws-sdk")},function(e,n,o){var t=o(0),s=t(),r=o(9),c=o(10),i=process.env.PORT||8080;s.use(t.static("build")),s.use(c.urlencoded({extended:!0})),s.use(c.json()),o(11)(s),r.connect(process.env.MONGODB_URI||"mongodb://localhost/api",{useNewUrlParser:!0}).then(function(){console.log("Mongo is connected")}).catch(function(e){console.log(e),console.log("[31m[1m MongoDB Not Connected")}),s.listen(i,function(){return console.log("Listening on port 8080!")})},function(e,n){e.exports=require("mongoose")},function(e,n){e.exports=require("body-parser")},function(e,n,o){e.exports=function(e){e.use("/login",o(12)),e.use("/portal",o(15))}},function(e,n,o){var t=o(0).Router();t.use("/auth",o(13)),e.exports=t},function(e,n,o){var t=o(0).Router();o(1).config();o(3)(),o(2);var s=o(4),r=(o(5),o(6),o(7));r.config.update({region:"ca-central-1"});var c=new r.CognitoIdentityServiceProvider;new r.CognitoIdentity;t.post("/authenticateuser",function(e,n){console.log("server");var o=e.body,t=o.value.user;console.log(o);var i={AuthFlow:"USER_PASSWORD_AUTH",ClientId:process.env.ClientId,AuthParameters:{USERNAME:o.value.user,PASSWORD:o.value.pass}};c.initiateAuth(i,function(e,c){if(e)console.log(e,e.stack),n.json(e);else if(c.ChallengeName===process.env.Challenge_NEW_PASS)n.json({changePass:"changepass",session:c.Session});else if(c.ChallengeName===process.env.Challenge_MFA)console.log(c),n.json({MFA:"MFA",session:c.Session,user:o.value.user});else{var i=c.AuthenticationResult.AccessToken,a=c.AuthenticationResult.IdToken;r.config.credentials=new r.CognitoIdentityCredentials(s.createLoginMap(process.env.IdentityPoolId,process.env.CognitoIdp,a,t,process.env.Region)),n.json({accessToken:i,idToken:a,user:o.value.user})}})}),t.post("/sendnewpass",function(e,n){var o={ChallengeName:process.env.Challenge_NEW_PASS,ClientId:process.env.ClientId,ChallengeResponses:{USERNAME:"".concat(e.body.user),NEW_PASSWORD:"".concat(e.body.newPass)},Session:e.body.session};c.respondToAuthChallenge(o,function(o,t){if(o)n.json(o);else if(t.ChallengeName===process.env.Challenge_MFA)console.log(t),n.json({MFA:"MFA",session:t.Session,user:e.body.user});else{var s=t.AuthenticationResult.AccessToken,r=t.AuthenticationResult.IdToken;n.json({accessToken:s,idToken:r,user:e.body.user})}})}),t.post("/sendmfa",function(e,n){var o=e.body,t=e.body.value.user,i={ChallengeName:process.env.Challenge_MFA,ClientId:process.env.ClientId,ChallengeResponses:{USERNAME:"".concat(e.body.value.user),SMS_MFA_CODE:"".concat(o.value.MFA)},Session:e.body.value.session};c.respondToAuthChallenge(i,function(o,c){if(o)n.json(o);else{var i=c.AuthenticationResult.AccessToken,a=c.AuthenticationResult.IdToken;r.config.credentials=new r.CognitoIdentityCredentials(s.createLoginMap(process.env.IdentityPoolId,process.env.CognitoIdp,a,t,process.env.Region)),n.json({accessToken:i,idToken:a,user:e.body.value.user})}})}),t.post("/logoutuser",function(e,n){var o=JSON.parse(e.body.value.uservalTemp);console.log(o);var t={AccessToken:"".concat(o.accessToken)};c.globalSignOut(t,function(e,o){e?n.json({putData:e,signOut:!1}):n.json({putData:o,signOut:!0})})}),e.exports=t},function(e,n){e.exports=require("fs")},function(e,n,o){var t=o(0).Router();t.use("/auth",o(16)),e.exports=t},function(e,n,o){function t(e,n,o,t,s,r,c){try{var i=e[r](c),a=i.value}catch(e){return void o(e)}i.done?n(a):Promise.resolve(a).then(t,s)}var s=o(0).Router();o(1).config();var r=o(3)(),c=o(2),i=o(5),a=o(6),u=(o(4),o(7));u.config.update({region:"ca-central-1"});var l=new u.CognitoIdentityServiceProvider;s.post("/coverter/csvjson",r.single("csv"),function(e,n){var o=e.file.buffer.toString("utf8");c(o,{columns:!0},function(e,o){var t=i.storeData(o);t?n.json(t):n.json("Please follow header guidelines")})}),s.post("/transfer/checks3",function(e,n,o){console.log("transfer started");var t=e.body.val;console.log(t);var s={AccessToken:"".concat(t.acToken)};l.getUser(s,function(o,s){var r,c;o?(console.log("error on check"),console.log(o),n.json("noAuth")):(console.log("get user results"),console.log(s),r=t,c=e.body.jsonReadyForS3,u.config.credentials.get(function(e){if(e)console.log("errored on creds"),console.log(e);else{var o,t,s;o=u.config.credentials.accessKeyId,t=u.config.credentials.secretAccessKey,s=u.config.credentials.sessionToken;var i={accessKeyId:"".concat(o),secretAccessKey:"".concat(t),sessionToken:"".concat(s)},l=new u.S3({creds:i,signatureVersion:"v4"}),f=r.fileName,d=f.split(".")[0],p=d.split("_"),v=f.substr(0,f.lastIndexOf("."))+".JSON",g={Bucket:process.env.Main_Bucket,Key:"RCL/Partner-List/".concat(process.env.Partner_ID)},y={Bucket:process.env.Main_Bucket,Key:"RCL/Archive/Users/".concat(r.email,"/").concat(v)},h={Bucket:process.env.Main_Bucket,Key:"RCL/Active/Users/".concat(r.email,"/").concat(v)},b={Bucket:process.env.Main_Bucket,Key:"RCL/Active/Users/".concat(r.email,"/")};l.getObject(g,function(e,o){console.log("starting getobject"),e?(console.log(e),n.json(e)):a.readFile(o.Body,c,p[0],function(e){switch(e){case"Partner exists":stepToUpload();break;case"Partner does not exist":return n.json("unauthorized-Partner"),!1}})}),stepToUpload=function(){l.headObject(b,function(e,o){e?(console.log(e),n.json("noEmail")):l.headObject(h,function(e,o){e?l.headObject(y,function(e,o){e?n.json("noFile"):n.json("fileExists")}):n.json("fileExists")})})}}}))})}),s.post("/transfer/sendtos3",function(e,n,o){var s=e.body.val;console.log("-----on upload-----"),u.config.credentials.get(function(o){if(o)n.json(o);else{var r=u.config.credentials.accessKeyId,c=u.config.credentials.secretAccessKey,i=u.config.credentials.sessionToken,a={accessKeyId:"".concat(r),secretAccessKey:"".concat(c),sessionToken:"".concat(i)},f=new u.S3({creds:a,signatureVersion:"v4"}),d={Bucket:process.env.Main_Bucket,Key:"RCL/Active/Users/".concat(e.body.val.email,"/").concat(e.body.jsonName),Body:JSON.stringify(e.body.jsonReadyForS3),ServerSideEncryption:process.env.Encryption};f.putObject(d,function(){var e,o=(e=regeneratorRuntime.mark(function e(o,t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o?(l.globalSignOut(paramsLogout,function(e,n){}),n.json(o)):(r={AccessToken:"".concat(s.acToken)},l.globalSignOut(r,function(e,o){e?n.json({putData:e,signOut:!1}):n.json({putData:t,signOut:!0})}));case 1:case"end":return e.stop()}},e)}),function(){var n=this,o=arguments;return new Promise(function(s,r){var c=e.apply(n,o);function i(e){t(c,s,r,i,a,"next",e)}function a(e){t(c,s,r,i,a,"throw",e)}i(void 0)})});return function(e,n){return o.apply(this,arguments)}}())}})}),e.exports=s}]);